<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Trino</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/black.css">
		<link rel="stylesheet" href="dist/theme/custom.css" />

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css">
		
		<style>
			img.carita-r1-c1 {
				background-image: url('/img/emojis.png');
				background-repeat: no-repeat;
				height: 130px;
				width: 130px;
				display: inline-block;
				background-position: 0px 0;
			}
			img.carita-r1-c2 {
				background-image: url('/img/emojis.png');
				background-repeat: no-repeat;
				height: 130px;
				width: 130px;
				display: inline-block;
				background-position: -200px 0;
			}
			img.carita-r1-c3 {
				background-image: url('/img/emojis.png');
				background-repeat: no-repeat;
				height: 130px;
				width: 130px;
				display: inline-block;
				border-style: hidden;
				background-position: -400px 0;
			}
			img.carita-r2-c1 {
				background-image: url('/img/emojis.png');
				background-repeat: no-repeat;
				height: 130px;
				width: 130px;
				display: inline-block;
				background-position: 0px -188px;
			}
			img.carita-r2-c2 {
				background-image: url('/img/emojis.png');
				background-repeat: no-repeat;
				height: 130px;
				width: 130px;
				display: inline-block;
				background-position: -200px -188px;
			}
			img.carita-r2-c3 {
				background-image: url('/img/emojis.png');
				background-repeat: no-repeat;
				height: 130px;
				width: 130px;
				display: inline-block;
				background-position: -400px -188px;
			}
			img.carita-r3-c1 {
				background-image: url('/img/emojis.png');
				background-repeat: no-repeat;
				height: 130px;
				width: 130px;
				display: inline-block;
				background-position: 0px -376px;
			}
			img.carita-r3-c2 {
				background-image: url('/img/emojis.png');
				background-repeat: no-repeat;
				height: 130px;
				width: 130px;
				display: inline-block;
				background-position: -200px -376px;
			}
			img.carita-r3-c3 {
				background-image: url('/img/emojis.png');
				background-repeat: no-repeat;
				height: 130px;
				width: 130px;
				display: inline-block;
				background-position: -400px -376px;
			}
			.fragment.current-visible.visible:not(.current-fragment) {
				display: none;
				height:0px;
				line-height: 0px;
				font-size: 0px;
			}
		</style>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<h1><code>Trino</code></h1>
					<img class="top framed" src="img/Trino_homepage.png" />
					<div class="r-stack">
						<p class="fragment fade-out" data-fragment-index="0">
							<span class="red">Un breve vistazo a Trino</span>
						</p>
						<p class="fragment current-visible" data-fragment-index="0">
							<span class="red">Un (no tan) breve vistazo a Trino</span>
						</p>
					</div>
					<a class="fragment" style="font-size: 0.75em;" href="https://edatos.github.io/trino-istac/">https://edatos.github.io/trino-istac/.</a>
				</section>

<!-- INTRODUCCION -->
				<section>
				  <h3>Índice</h3>
				  <ol>
					<li class="fragment highlight-red">Introducción y conceptos básicos</li>
					<li>Funcionalidades</li>
					<li>Instalación y configuración</li>
					<li>Pruebas realizadas</li>
					<li>Conclusiones</li>
				  </ol>
				</section>

				<section>
				<h2>Introducción y conceptos básicos</h2>
				</section>
				
				<section>
					<h4>¿Qué es Trino?</h4>
						<ul>
							<li class="fragment" _data-fragment-index="1">Es un motor SQL distribuido ideado para trabajar con grandes volúmenes de datos de una gran variedad de sistemas de datos.</li>
							<li class="fragment" _data-fragment-index="2">Desarrollado en Java (soporta Openjava). Tecnología madura y fiable.</li>
							<li class="fragment" _data-fragment-index="2">Diseñado para un rendimiento óptimo y escalable.</li>
							<li class="fragment" _data-fragment-index="3" style="color:red">No es una base de datos: no almacena datos.</li>
						</ul>
				</section>
				
				<section>
					<h4>¿Por qué usar Trino?</h4>
					<div class="r-stack">
						<div class="blk-full">
							<ul>
								<li class="fragment">Velocidad</li>
								<li class="fragment">Escalado</li>
								<li class="fragment">Simplicidad</li>
								<li class="fragment">Versatilidad</li>
								<li class="fragment">Análisis in-situ</li>
								<li class="fragment">Query federation</li>
								<li class="fragment">Funciona en cualquier lugar</li>
								<li class="fragment">Confiable</li>
								<li class="fragment">Abierto</li>
							</ul>
						</div>
						<img class="top framed fragment" src="img/memes/suatmm.gif" />
					</div>
				</section>

				<section>
					<h4>Historia</h4>
					<ul>
						<li><span>Proyecto Presto en Facebook en 2012.</span></li>
						<li><span>En 2013 se liberó con licencia Apache.</span></li>
						<li><span>La versión más reciente es la v380 (6/5/22).</span></li>
					</ul>
				</section>
				
				<section>
					<h4>¿Quién usa Trino?</h4>
					<img class="w70" src="img/Trino-usuarios.png" />
				</section>
				
				<section>
					<h4>Conceptos básicos - I</h4>
					<p>Arquitectura del sistema</p>
					<ul>
						<li class="fragment">
							<p>Trino es un sistema en cluster.</p>
							<div class="fragment">
							<p>Tipos de nodos:</p>
							<ol>
								<li>Coordinator<span class="fragment">: El cerebro...</span></li>
								<li>Worker<span class="fragment">: El currito...</span></li>
							</ol>
							</div>
						</li>
					</ul>
				</section>
				
				<section>
					<h4>Conceptos básicos - I</h4>
					<img class="top framed" src="img/Trino_architecture.png" />
				</section>
				
				<section>
					<section>
						<h4>Conceptos básicos - II</h4>
						<p>En relación a los datos</p>
						<ol start="1">
							<li class="fragment"><strong>Connector</strong>: Interfaz a sistemas de datos.</li>
							<li class="fragment"><strong>Catalog</strong>: Metadatos de las fuentes de datos.</li>
							<li class="fragment"><strong>Schema</strong>: Organización de las tablas de datos.</li>
							<li class="fragment"><strong>Table</strong>: Grupo de registros.</li>
						</ol>
					</section>
					<section>
						<p style="font-size: 0.65em;">Comparativa entre distintos sistemas</p>
						<img class="top framed" src="img/Trino-containment-hierarchy.png" />
					</section>
				</section>
				
				<section>
					<section>
						<h4>Conceptos básicos - III</h4>
						<p>En relación al modelo de ejecución</p>
						<ol start="1">
							<li class="fragment"><strong>Statement</strong>: El comando SQL</li>
							<li class="fragment"><strong>Query</strong>: Colección de objetos</li>
							<li class="fragment"><strong>Stage</strong>: Pasos</li>
							<li class="fragment"><strong>Task</strong>: Tarea</li>
							<li class="fragment"><strong>Driver</strong>: Subtareas</li>
							<li class="fragment"><strong>Operator</strong>: Operadores</li>
							<li class="fragment"><strong>Otros</strong>: Exchange, Split</li>
						</ol>
					</section>
					<section>
						<img class="top framed" src="img/pantallazos/p007.png" />
					</section>
				</section>
				

<!-- FUNCIONALIDADES -->
				<section>
				  <h3>Índice</h3>
				  <ol>
					<li>Introducción y conceptos básicos</li>
					<li style="color: red">Funcionalidades</li>
					<li>Instalación y configuración</li>
					<li>Pruebas realizadas</li>
					<li>Conclusiones</li>
				  </ol>
				</section>
				
				<section>
					<section>
						<h4>Funcionalidades - I</h4>
							<ol start="1">
								<li class="fragment">Web UI</li>
							</ol>
							</br>
							<ul class="fragment" style="font-size: 0.65em;">
								<li class="fragment">Es la interfaz de usuario que permite monitorizar el cluster de nodos y manejar las queries.</li>
								<li class="fragment">Puede hacerse un seguimiento de su ejecución y detalles de las queries.</li>
								<li class="fragment">No permite lanzar queries</li>
								<li class="fragment">No muestra los datos resultantes</li>
							</ul>
					</section>
					<section>
						<!-- Imagen #1 -->
						<img class="top framed" src="img/pantallazos/p003.png" />
					</section>
					<section>
						<!-- Imagen #2 -->
						<img class="top framed" src="img/pantallazos/p001.png" />
					</section>
					<section>
						<!-- Imagen #3 -->
						<img class="top framed" src="img/pantallazos/p004.png" />
					</section>
					<section>
						<!-- Imagen #4 -->
						<img class="top framed" src="img/pantallazos/p005.png" />
					</section>
					<section>
						<!-- Imagen #5 -->
						<img class="top framed" src="img/pantallazos/p006.png" />
					</section>
					<section>
						<img class="top framed" src="img/pantallazos/p011.png" />
					</section>
					<section>
						<img class="top framed" src="img/pantallazos/p009.png" />
					</section>
				</section>
				
				<section>
					<h4>Funcionalidades - II</h4>
					<ol start="2">
						<li class="fragment"><b>Autenticación de usuarios</b></li>
						<li class="fragment"><b>Autorización de usuarios</b></li>
						<li class="fragment"><b>Clientes: Trino CLI, Trino Web UI y librerías para intergrar en aplicaciones.</b></li>
						<li class="fragment"><b>Comunicaciones seguras</b></li>
						<li class="fragment"><b>Extensible</b></li>
					</ol>
				</section>
				
				<section>
					<section>
						<h4>Funcionalidades - III</h4>
						<ol start="7">
							<li class="fragment"><b>Quotas sobre los recursos</b></li>
							<li class="fragment"><b>Lenguaje SQL potente</b></li>
							<li class="fragment"><b>Connectors preinstalados</b>
								<ul class="fragment fade-in-then-out" style="font-size: 0.65em;">
									<li>TPCDS</li>
									<li>TPCH</li>
									<li>JMX</li>
									<li>SYSTEM</li>
									<li>MEMORY</li>
									<li>BLACK HOLE</li>
									<li><b>...</b></li>
								</ul>
							</li>
						</ol>
					</section>
					<section>
						<h4>Ejemplo - Consulta de métrica</h4>
						<p style="font-size: 0.65em;">Número de ficheros abiertos en cada nodo</p>
						<pre><code data-trim data-noescape style="font-size: 0.6em;">
trino> SELECT openfiledescriptorcount FROM jmx.current."java.lang:type=operatingsystem";
ERROR: failed to open pager: Cannot run program "less": CreateProcess error=2, El sistema no puede encontrar el archivo especificado
 openfiledescriptorcount
-------------------------
                    2929
                    2928
                    2989
                    2933
(4 rows)

Query 20220519_002644_00001_7jb7m, FINISHED, 4 nodes
Splits: 6 total, 6 done (100,00%)
4,50 [4 rows, 32B] [0 rows/s, 7B/s]
						</code></pre>
					</section>
				</section>
				
				<section>
					<section>
						<h4>Funcionalidades - IV</h4>
						<ol start="10" style="font-size: 0.75em;">
							<li class="fragment"><strong>SQL-on-Anything</strong>: SQL para todo.
								<ul style="font-size: 0.65em;">
									<li>TPCDS</li>
									<li>TPCH</li>
									<li>JMX</li>
									<li>SYSTEM</li>
									<li>MEMORY</li>
									<li>BLACK HOLE</li>
									<li><b>...</b></li>
								</ul>
							</li>
							<li class="fragment"><strong>Federated Query</strong>: Queries sobre varias fuentes de datos.</li>
							<li class="fragment"><strong>Virtual Data Warehouse</strong>: Almacenamiento homogéneo.</li>
							<li class="fragment"><strong>Procesamiento/Almacenamiento</strong>: Aisla los recursos usados por las queries de los usados por el almacenamiento.</li>
						</ol>
					</section>
					<section>
						<p style="font-size: 0.65em;">Tipos de Bases de Datos</p>
						<ul style="font-size: 0.65em;">
							<li>RDBMS (Microsoft SQL Server, Oracle Database, MySQL, PostgreSQL, ...)</li>
							<li>NoSQL (Apache Cassandra, MongoDB, CouchDB, ...)</li>
							<li>Cloud databases (Microsoft Azure SQL Database, Amazon Relational Database Service, Oracle Autonomous Database, ...)</li>
							<li>Columnar databases (Google BigQuery, Cassandra, HBase, MariaDB, Azure SQL Data Warehouse, ...)</li>
							<li>Wide column databases (BigTable, Apache Cassandra and Scylla, ...)</li>
							<li>Object-oriented databases (Wakanda, ObjectStore, ...)</li>
							<li>Key-value databases (Amazon DynamoDB, Redis, ...)</li>
							<li>Hierarchical databases (IBM Information Management System (IMS), Windows Registry, ...)</li>
							<li>Document databases (MongoDB, Amazon DocumentDB, Apache CouchDB, ...)</li>
							<li>Graph databases (Datastax Enterprise Graph, Neo4J, ...)</li>
							<li>Time series databases (Druid, eXtremeDB, InfluxDB, ...)</li>
							<li></li>
							<li></li>
						</ul>
					</section>
					<section>
						<p style="font-size: 0.65em;">Tipos de Bases de Datos NoSQL</p>
						<img class="top framed" src="img/types-of-databases3.png" />
					</section>
				</section>
				
				<section>
					<section>
						<h4>Funcionalidades - V</h4>
						<ol start="14">
							<li class="fragment"><strong>Query optimizer</strong>: Uso de datos estadísticos.
								<ul>
									<li class="fragment">Tablas
										<ul>
											<li>Row count</li>
										</ul>
									</li>
									<li class="fragment">Columnas
										<ul>
											<li>Data size</li>
											<li>Nulls fraction</li>
											<li>Distinct value count</li>
											<li>Low value</li>
											<li>High value</li>
										</ul>
									</li>
								</ul>
							</li>
						</ol>
					</section>					
					<section>
						<h4>Ejemplo - Comando SHOW STATS</h4>
						<pre><code data-trim data-noescape style="font-size: 0.6em;">
trino> show stats for ppa.public.tb_encuesta;
ERROR: failed to open pager: Cannot run program "less": CreateProcess error=2, El sistema no puede encontrar el archivo especificado
      column_name       |      data_size      | distinct_values_count |   nulls_fraction    | row_count | low_value | high_value
------------------------+---------------------+-----------------------+---------------------+-----------+-----------+------------
 id_establecimiento     |                 5.0 |                   1.0 |                 0.0 |      NULL | NULL      | NULL
 id_producto            |                 3.0 |   0.20454545319080353 |                 0.0 |      NULL | NULL      | NULL
 id_grupo_producto      |                 3.0 |   0.15909090638160706 |                 0.0 |      NULL | NULL      | NULL
 latitud                |                 4.0 |                   1.0 |                 0.0 |      NULL | NULL      | NULL
 longitud               |                 5.0 |                   1.0 |                 0.0 |      NULL | NULL      | NULL
 id_marca               |  1.8181819915771484 |   0.11363636702299118 |  0.7727272510528564 |      NULL | NULL      | NULL
 marca_aux              |   1.624999761581421 |   0.13636364042758942 |  0.8522727489471436 |      NULL | NULL      | NULL
 variedad               |                 0.0 |                   0.0 |                 1.0 |      NULL | NULL      | NULL
 formato_aux            |                 0.0 |                   0.0 |                 1.0 |      NULL | NULL      | NULL
 cantidad               |                NULL |   0.28409090638160706 | 0.13636364042758942 |      NULL | NULL      | NULL
 precio                 |                NULL |    0.6818181872367859 |                 0.0 |      NULL | NULL      | NULL
 ano                    |                 5.0 |                   1.0 |                 0.0 |      NULL | NULL      | NULL
 mes                    |                 3.0 |                   1.0 |                 0.0 |      NULL | NULL      | NULL
 fecha_hora_recogida    |                NULL |                   1.0 |                 0.0 |      NULL | NULL      | NULL
 id_articulo            | 0.28409063816070557 |  0.011363625526428223 |  0.9886363744735718 |      NULL | NULL      | NULL
 descripcion_incidencia |                 0.0 |                   0.0 |                 1.0 |      NULL | NULL      | NULL
 created_at             |                NULL |   0.46590909361839294 |                 0.0 |      NULL | NULL      | NULL
 updated_at             |                NULL |   0.46590909361839294 |                 0.0 |      NULL | NULL      | NULL
 id_estado              |                 5.0 |                   1.0 |                 0.0 |      NULL | NULL      | NULL
 id_formato             |   8.335227448940277 |    0.9261363670229912 | 0.07386363297700882 |      NULL | NULL      | NULL
 id_unidad_medida       |   1.863636391727548 |    0.9318181797862053 | 0.06818182021379471 |      NULL | NULL      | NULL
 NULL                   |                NULL |                  NULL |                NULL |       1.0 | NULL      | NULL
(22 rows)

Query 20220518_150518_00007_b78u8, FINISHED, 1 node
Splits: 1 total, 1 done (100,00%)
0,39 [0 rows, 0B] [0 rows/s, 0B/s]
						</code></pre>
					</section>
					<section>
						<h4>Ejemplo - Comando EXPLAIN</h4>
						<pre><code data-trim data-noescape style="font-size: 0.6em;">
trino> EXPLAIN select count(*) from fermio.e59021a_rd.urd_llamcan20201231_v01;
ERROR: failed to open pager: Cannot run program "less": CreateProcess error=2, El sistema no puede encontrar el archivo especificado
                                                                          Query Plan
--------------------------------------------------------------------------------------------------------------------------------------------------------------
 Fragment 0 [SINGLE]
     Output layout: [_pfgnrtd]
     Output partitioning: SINGLE []
     Stage Execution Strategy: UNGROUPED_EXECUTION
     Output[_col0]
     Ôöé   Layout: [_pfgnrtd:bigint]
     Ôöé   Estimates: {rows: 1 (9B), cpu: 9, memory: 0B, network: 9B}
     Ôöé   _col0 := _pfgnrtd
     ÔööÔöÇ RemoteSource[1]
            Layout: [_pfgnrtd:bigint]

 Fragment 1 [SOURCE]
     Output layout: [_pfgnrtd]
     Output partitioning: SINGLE []
     Stage Execution Strategy: UNGROUPED_EXECUTION
     TableScan[fermio:Query[SELECT count(*) AS "_pfgnrtd_0" FROM "e59021a_rd"."urd_llamcan20201231_v01"] columns=[_pfgnrtd_0:bigint:bigint], grouped = false]
         Layout: [_pfgnrtd:bigint]
         Estimates: {rows: 1 (9B), cpu: 9, memory: 0B, network: 0B}
         _pfgnrtd := _pfgnrtd_0:bigint:bigint


(1 row)

Query 20220518_151129_00008_b78u8, FINISHED, 1 node
Splits: 1 total, 1 done (100,00%)
1,30 [0 rows, 0B] [0 rows/s, 0B/s]
						</code></pre>
					</section>
				</section>
				
				<section>
					<section>
						<h4>Funcionalidades - VI</h4>
						<ol start="14">
							<li class="fragment"><strong>Query optimizer</strong>: Pushdown.
								<ul>
									<li>Predicate (WHERE)</li>
									<li>Projection (SELECT)</li>
									<li>Dereference</li>
									<li>Aggregation (GROUP BY)</li>
									<li>Join (JOIN)</li>
									<li>Limit (LIMIT)</li>
									<li>Top-N</li>
								</ul>
							</li>
						</ol>
					</section>
					<section>
						<img class="top framed" src="img/sql-queries.jpeg"  width="400" height="400" />
					</section>
					<section>
						<p>¿Qué son las windows functions?</p>
						<div  style="font-size: 0.65em;">
							<blockquote>Realizan cálculos sobre un conjunto de registros relacionados con el actual, de forma similar a las funciones de agregación pero sin agrupar filas.</blockquote>
							<pre><code data-trim data-noescape>
								SELECT
									duration,
									SUM(duration) <u>OVER</u> (ORDER BY start_time) AS running_total
								FROM
									tasks;
							</code></pre>
						</div>
					</section>
				</section>
				
				<section>
					<h4>Funcionalidades - VII</h4>
					<ol start="15">
						<li class="fragment" data-fragment-index="0">Spill to disk</li>
						<li class="fragment" data-fragment-index="1">Dynamic filtering</li>
						<img class="fragment top framed" data-fragment-index="1" src="img/585px-Joins_del_SQL.svg.png" style="background-color: #6DB3F2;" />
					</ol>
				</section>

				
				<section>
					<h4>Funcionalidades - VIII</h4>
					<ol start="17">
						<li class="fragment">Resource groups</li>
						<li class="fragment">Session properties</li>
					</ol>
				</section>

				
				<section>
					<section>
						<h4>Funcionalidades - IX</h4>
						<ol start="19">
							<li class="fragment">Distributed sort</li>
							<li class="fragment">Graceful shutdown</li>
						</ol>
					</section>
					<section>
						<p>Ejemplo de apagado de nodo worker</p>
						<pre><code data-trim data-noescape style="font-size: 0.6em;">curl -X PUT -d '"SHUTTING_DOWN"' -H "Content-type: application/json" http://worker:8081/v1/info/state</code></pre>
					</section>
				</section>

				
				<section>
					<h4>Funcionalidades - X</h4>
					<ol start="21">
						<li class="fragment">Fault-tolerant
							<ul>
								<li>Query retry</li>
								<li>Task retry</li>
							</ul>
						</li>
						<li class="fragment">JMX</li>
					</ol>
				</section>

<!-- INSTALACIÓN Y CONFIGURACIÓN -->
				<section>
				  <h3>Índice</h3>
				  <ol>
					<li>Introducción y conceptos básicos</li>
					<li>Funcionalidades</li>
					<li class="fragment highlight-red">Instalación y configuración</li>
					<li>Pruebas realizadas</li>
					<li>Conclusiones</li>
				  </ol>
				</section>

				<section>
					<section>
						<h4>Instalación docker</h4>
						<ol start="1" style="font-size: 0.65em;">
							<li>Configuración docker-compose</li>
							<span style="font-size: 0.5em;">fichero <i>docker-composer.yml</i></span>
							<pre style="font-size: 0.6em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
version: "3.9"

services:
  mi-proxy:
    build:
      context: mi-proxy
      args:
        SERVER_HOSTNAME: $SERVER_HOSTNAME
        TRINO_URL_PATH: $TRINO_URL_PATH
        TRINO_API_URL_PATH: $TRINO_API_URL_PATH
        TRINO_API_PORT: $TRINO_API_PORT
    image: mi-proxy
    container_name: mi-proxy
#    user: $TRINO_USER
    ports:
      - 443:443
    volumes:
      - ./mi-proxy/logs:/var/log/nginx
# Compartimos el socker de Docker Engine para poder usar el Docker Engine API dentro del contenedor
      - /var/run/docker.sock:/var/run/docker.sock
#     networks: 
#       - mi-proxy
#       - mi-trino
    restart: always
    depends_on:
      - mi-trino-coordinator

  mi-trino-coordinator:
    build:
      context: mi-trino-coordinator
      args:
        SERVER_HOSTNAME: $SERVER_HOSTNAME
#       Otros parámetros opcionales pueden ir aquí
#       Como los usados en https://github.com/trinodb/trino/blob/master/core/docker/README.md
#       docker exec -it trino trino --catalog tpch --schema sf1
    image: mi-trino-coordinator
    container_name: mi-trino-coordinator
    env_file:
      - .env
      - trino-catalogs/.env
#    user: $DOCKER_USER
    restart: always
    ports:
#   Mapeamos el puerto 80 externo al 8080 interno que es el puerto por defecto para HTTP usado en la imagen oficial del Trino.
#   Mapeamos el puerto 443 externo al 8443 interno que es el puerto para HTTPS por el servidor Trino.
      - "8080:8080"
      - "9000:9000"
#      - "443:8443"
    volumes:
      - ./trino-catalogs:/etc/trino/catalog:ro
      - ./mi-trino-coordinator/logs:/data/trino/var/log
      - ./mi-trino-coordinator/nodejs/files:/home/node/app/files
      - ./mi-trino-coordinator/nodejs/apps:/home/node/app/apps
      - ./mi-trino-coordinator/nodejs/logs:/var/log/trino-api
#      - ./mi-trino/files:/home/node/app/files
#      - ./mi-trino/apps:/home/node/app/apps
# Compartimos el socker de Docker Engine para poder usar el Docker Engine API dentro del contenedor
#      - /var/run/docker.sock:/var/run/docker.sock
#      - /tmp/docker-fake.sock:/tmp/docker-fake.sock


  mi-trino-worker:
    build:
      context: mi-trino-worker
      args:
        SERVER_HOSTNAME: $SERVER_HOSTNAME
#       Otros parámetros opcionales pueden ir aquí
#       Como los usados en https://github.com/trinodb/trino/blob/master/core/docker/README.md
#       docker exec -it trino trino --catalog tpch --schema sf1
    image: mi-trino-worker
#    container_name: mi-trino-worker0
    env_file:
      - .env
      - trino-catalogs/.env
    ports:
      - "8081-8091:8080"
    volumes:
      - ./trino-catalogs:/etc/trino/catalog:ro
      - ./mi-trino-worker/logs:/data/trino/var/log

							</code></pre>
						</ol>
					</section>
					<section>
						<h4>Instalación docker</h4>
						<span style="font-size: 0.325em;">fichero <i>.env</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
SERVER_HOSTNAME=cinco-ap01p.gobiernodecanarias.net
TRINO_URL_PATH=aplicaciones/trino
TRINO_SERVER_USER=admin
TRINO_SERVER_PASS=****
TRINO_INTERNAL_COMM_SHARED_SECRET=KCZZItOB+oAMHi5jH59pt4pBE
TRINO_API_URL_PATH=aplicaciones/trino/api
TRINO_API_PORT=9000
						</code></pre>
					</section>
					<section>
						<h4>Instalación docker</h4>
						<span style="font-size: 0.325em;">fichero <i>Dockerfile</i> (nodo coordinador)</span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
FROM trinodb/trino

ARG SERVER_HOSTNAME
ENV SERVER_HOSTNAME=${SERVER_HOSTNAME:-localhost}
ARG TRINO_API_PORT
ENV TRINO_API_PORT=${TRINO_API_PORT:-9000}

LABEL org.opencontainers.image.authors="miguel.nunez@evm.net"
LABEL Mi-TRINO='Trino Server v370'

# Instalamos el editor nano (para pruebas)
#RUN apt-get update && \
#    apt-get -y install nano

COPY --chown=trino:trino ./config/* /etc/trino/
#COPY --chown=trino:trino ./../trino-catalogs/* /etc/trino/catalog/
RUN rm -rf /etc/trino/catalog/*

##################
##### NODEJS #####
##################
# https://www.ibm.com/docs/en/z-chatops/1.1.0?topic=software-installing-nodejs
# Ficheros descargados offline usando el comando `curl -sL -o node-v18.1.0-linux-x64.tar.gz 'https://nodejs.org/dist/latest/node-v18.1.0-linux-x64.tar.gz'`
# NOTA: La versión docker del Centos no soporta el formato tar.xz.
COPY ./downloads/* /downloads/

USER root

# Instalamos el comando ps usado por el módulo node-ps para listar los procesos.
RUN dnf --disablerepo="*" --nodocs install -y /downloads/procps-ng-3.3.15-6.el8.x86_64.rpm && \
	rm -f /downloads/procps-ng-3.3.15-6.el8.x86_64.rpm

# Descomprimimos e instalamos los binarios del Node v18.1.0
RUN tar zxf /downloads/node-v18.1.0-linux-x64.tar.gz -C /opt && \
	rm -f /downloads/node-v18.1.0-linux-x64.tar.gz
ENV PATH="/opt/node-v18.1.0-linux-x64/bin:${PATH}"

RUN dnf clean all && rm -rf /var/cache/* /var/log/dnf* /downloads

# Añadimos un nuevo usuario (node)
RUN useradd -ms /bin/bash node
RUN mkdir -p /home/node/app/node_modules && chown -R node:node /home/node/app

# Creamos el directorio para los ficheros de logs
RUN mkdir -p /var/log/trino-api && chown -R node:node /var/log/trino-api

USER node

# Nuevo punto de entrada para este contenedor. Lanzará app.js (Trino-API) y luego el Trino.
COPY --chown=node:node ./docker-entrypoint.sh /docker-entrypoint.sh
RUN chmod a+x /docker-entrypoint.sh

# Copiamos todas las aplicaciones. El directorio /home/node/app/apps se debe exportar como un bind mount.
# NOTA: se requiere poner en el host permiso R/W para todos los usuarios en el directorio /home/ext-jnunperadm/infra/test-trino-multi/mi-trino-coordinator/apps
COPY --chown=node:node ./nodejs/apps /home/node/app/apps/
# Creamos el directorio a exportar para los ficheros a usar por las aplicaciones NodeJs (bind mount)
# NOTA: se requiere poner en el host permiso R/W para todos los usuarios en el directorio /home/ext-jnunper/infra/mi-nodejs/files
RUN mkdir /home/node/app/files
# Y cargamos sus dependencias
RUN find /home/node/app/apps -name package.json -maxdepth 2 -print0 | xargs -0 -r -n 1 -i sh -c 'cd -- $(dirname {}) ; echo "Instalando dependencias en $(pwd)..." ; npm install'

# Cargamos el módulo nodemon para relanzar el node con los cambios de los scripts.
RUN npm install -g nodemon

USER trino

##################
##### NODEJS #####
##################

RUN mkdir -p /data/trino/var/log && chown -R trino:trino /data/trino

USER root

EXPOSE $TRINO_API_PORT

CMD ["/docker-entrypoint.sh", "/usr/lib/trino/bin/run-trino"]
						</code></pre>
					</section>
					<section>
						<h4>Instalación docker</h4>
						<span style="font-size: 0.325em;">Contenedores docker en ejecución (cluster Trino)</span>
						<img class="top framed" src="img/pantallazos/p019.png" />
					</section>
				</section>

				<section>
					<section>
						<h4>Configuración Trino</h4>
						<ol start="2" style="font-size: 0.65em;">
							<li>Configuración nodo coordinador</li>
							<span style="font-size: 0.5em;">fichero <i>config.properties</i></span>
							<pre style="font-size: 0.6em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">							
#single node install config
coordinator=true
node-scheduler.include-coordinator=true
http-server.http.port=8080
discovery.uri=http://mi-trino-coordinator:8080


# https://trino.io/docs/current/security/tls.html#https-load-balancer
#http-server.https.enabled=true
http-server.process-forwarded=true

# Esto es para permitir usar la autenticación usuario/password con Trino CLI sin tener que activar HTTPS.
# Por ejemplo:  trino --user=miguel --password
# NO FUNCIONA ==> el paso de contraseña sigue exigiendo HTTPS.
# La solución es evitar el flag --password.
#http-server.authentication.allow-insecure-over-http=true

# Secreto compartido usado en las comunicaciones entre nodos. Debe ser el mismo en todos los ficheros config.properties de todos los nodos.
# https://trino.io/docs/current/security/internal-communication.html
# NOTA: El secreto de 512 bytes se ha generado usando el comando `openssl rand 512 | base64`.
internal-communication.shared-secret=KCZZItOB+oAMHi5jH59pt4pBE0l4zQc

# Configuramos la autenticación de usuarios (sólo se admiten usuarios ext-*@canarias.org ó *@gobiernodecanarias.org).
# https://trino.io/docs/current/security/user-mapping.html
# En este ejemplo, bloquea el acceso al cluster del usuario etormed y se permite al resto, además se mapean los usuarios ext-* a ext-*@canarias.es.
http-server.authentication.type=PASSWORD
http-server.authentication.password.user-mapping.file=etc/user-mapping.json

# Ocultar columnas no autorizadas en lugar de emitir un error
#hide-inaccessible-columns = true

# Web-UI
# https://trino.io/docs/current/admin/web-interface.html
#
# Propiedades del Web-UI
# https://trino.io/docs/current/admin/properties-web-interface.html
#web-ui.enabled=false
							</code></pre>
						</ol>
					</section>
					<section>
						<h4>Configuración Trino</h4>
						<span style="font-size: 0.325em;">fichero <i>access-control.properties</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
# Reglas de control de acceso para todo el cluster.
# https://trino.io/docs/current/security/file-system-access-control.html#system-level-access-control-files
# NOTA: No parece existir un Group provider por defecto (hay que crear uno como un plugin) según se indica en https://trino.io/docs/current/develop/group-provider.html
# Teniedo un Group provider, se pueden aplicar reglas de autorización a grupos de usuarios.
access-control.name=file
#security.config-file=/etc/trino/cluster-auth-rules.json

# TEST_1: Reglas
#   Todo el mundo tiene acceso total a todos los catálogos, excepto el catálogo ACTINIO que sólo es accesible en modo lectura para los usuarios ext-jnunper@canarias.es y etormed.
#   Todo el mundo puede ejecutar queries, el usuario etormed puede matar sus queries y el usuario ext-jnunper@canarias puede ver, ejecutar y matar de todos los usuarios.
security.config-file=/etc/trino/cluster-auth-rules.test1.json

# Releemos cada segundo el fichero de reglas para aplicar cambios
security.refresh-period=1s
						</code></pre>
					</section>
					<section>
						<h4>Configuración Trino</h4>
						<span style="font-size: 0.325em;">fichero <i>cluster-auth-rules.json</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
{
    "catalogs": [{
            "role": "admin",
            "catalog": "(mysql|system)",
            "allow": "all"
        }, {
            "group": "finance|human_resources",
            "catalog": "postgres",
            "allow": true
        }, {
            "catalog": "hive",
            "allow": "all"
        }, {
            "user": "alice",
            "catalog": "postgresql",
            "allow": "read-only"
        }, {
            "catalog": "system",
            "allow": "none"
        }
    ],
    "schemas": [{
            "role": "admin",
            "schema": ".*",
            "owner": true
        }, {
            "user": "guest",
            "owner": false
        }, {
            "catalog": "default",
            "schema": "default",
            "owner": true
        }
    ],
    "tables": [{
            "role": "admin",
            "privileges": ["SELECT", "INSERT", "DELETE", "OWNERSHIP"]
        }, {
            "user": "banned_user",
            "privileges": []
        }, {
            "catalog": "default",
            "schema": "hr",
            "table": "employee",
            "privileges": ["SELECT"],
            "filter": "user = current_user",
            "filter_environment": {
                "user": "system_user"
            }
        }, {
            "catalog": "default",
            "schema": "default",
            "table": ".*",
            "privileges": ["SELECT"],
            "columns": [{
                    "name": "address",
                    "allow": false
                }, {
                    "name": "SSN",
                    "mask": "'XXX-XX-' + substring(credit_card, -4)",
                    "mask_environment": {
                        "user": "system_user"
                    }
                }
            ]
        }
    ],
    "system_session_properties": [{
            "role": "admin",
            "allow": true
        }, {
            "user": "banned_user",
            "allow": false
        }, {
            "property": "resource_overcommit",
            "allow": true
        }
    ],
    "catalog_session_properties": [{
            "role": "admin",
            "allow": true
        }, {
            "user": "banned_user",
            "allow": false
        }, {
            "catalog": "hive",
            "property": "bucket_execution_enabled",
            "allow": true
        }
    ],
    "queries": [{
            "role": "admin",
            "allow": ["execute", "kill", "view"]
        }, {
            "user": "alice",
            "allow": ["execute", "kill"]
        }, {
            "group": "contractors",
            "queryOwner": "alice|dave",
            "allow": ["view"]
        }, {
            "allow": ["execute"]
        }
    ],
    "impersonation": [{
            "original_role": "admin",
            "new_user": "bob",
            "allow": false
        }, {
            "original_role": "admin",
            "new_user": ".*"
        }, {
            "original_user": ".*",
            "new_user": "test"
        }
    ],
    "system_information": [{
            "role": "admin",
            "allow": ["read", "write"]
        }, {
            "user": "alice",
            "allow": ["read"]
        }
    ]
}
						</code></pre>
					</section>
					<section>
						<h4>Configuración Trino</h4>
						<span style="font-size: 0.325em;">fichero <i>group-provider.properties</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
# File group provider
# https://trino.io/docs/current/security/group-file.html
group-provider.name=file
file.group-file=/etc/trino/grupos-usuarios.txt
file.refresh-period=10s
						</code></pre>
					</section>
					<section>
						<h4>Configuración Trino</h4>
						<span style="font-size: 0.325em;">fichero <i>grupos-usuarios.txt</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
admin:ext-jnunper@canarias.es
lectores:ext-jnunper@canarias.es,etormed,ext-jgilcar@canarias.es,ext-mhergark@canarias.es
escritores: etormed
						</code></pre>
					</section>
					<section>
						<h4>Configuración Trino</h4>
						<span style="font-size: 0.325em;">fichero <i>password-authenticator.properties</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
# # Datos del mecanimos de autenticación de usuarios mediante claves.
# # https://trino.io/docs/current/security/password-file.html
# password-authenticator.name=file
# file.password-file=/etc/trino/usuarios.db
# #file.refresh-period=5s
# #file.auth-token-cache.max-size=1000

# Mecanismo de autenticación por LDAP
# Usuario de búsqueda (no usado): uid=trino-ldap,o=applications,o=gobiernodecanarias,c=es
password-authenticator.name=ldap
ldap.url=ldap://directorio-pre.gobiernodecanarias.net:389
ldap.allow-insecure=true
ldap.user-bind-pattern=uid=${USER},o=gobiernodecanarias,c=es:uid=${USER},o=canarias.org,c=es
#ldap.bind-dn=uid=trino-ldap,o=applications,o=gobiernodecanarias,c=es
#ldap.bind-password=****
						</code></pre>
					</section>
					<section>
						<h4>Configuración Trino</h4>
						<span style="font-size: 0.325em;">fichero <i>user-mapping.json</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
{
  "rules": [
    {
      "pattern": "(ext-.+)",
      "case": "lower",
      "user": "$1@canarias.es",
      "allow": true
    },
    {
      "pattern": "(.+)",
      "allow": true
    }
  ]
}						</code></pre>
					</section>
					<section>
						<h4>Configuración Trino</h4>
						<span style="font-size: 0.325em;">fichero <i>log.properties</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
# Nivel de logging de los distintos componentes de TrinoDB
# https://trino.io/docs/current/installation/deployment.html#log-levels
io.trino=INFO
io.trino.plugin.password=DEBUG						</code></pre>
					</section>
					<section>
						<h4>Configuración Trino</h4>
						<span style="font-size: 0.325em;">fichero <i>usuarios.db</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
miguel:$2y$10$RkOdWEkLHjaAds7Kzp0C3eWNHVzoawLolnmnvdbsxQUB0ACjQzeAO
user_ro:$2y$10$.VJ6yKEuWo38NXK.bd6/J.ML5.sfEFA1B.0jNoyMw/VsQzoLAjNc6
user_rw:$2y$10$5us6RyTDd/ynlOt.IX0R1eHu9laNqGtOfBfUGm.ZYMgUty6QdBKIO
						</code></pre>
					</section>
				</section>

				<section>
					<section>
						<h4>Configuración Trino</h4>
						<ol start="3" style="font-size: 0.65em;">
							<li>Catálogos</li>
							<span style="font-size: 0.5em;">fichero <i>.env</i></span>
							<pre style="font-size: 0.6em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">							
DB_FERMIO_USER=extjnunper
DB_FERMIO_PASSWORD=****
DB_OISTAC_USER=extjnunper
DB_OISTAC_PASSWORD=****
DB_PPA_USER=root
DB_PPA_PASSWORD=****
DB_ACTINIO_USER=extjnunper
DB_ACTINIO_PASSWORD=****
							</code></pre>
						</ol>
					</section>
					<section>
						<h4>Configuración Trino</h4>
						<span style="font-size: 0.325em;">fichero <i>actinio.properties</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
connector.name=postgresql
### Conexión al servidor ACTINIO (actinio.istac.local)
connection-url=jdbc:postgresql://xxx.xxx.xxx.xxx:xxxx/pistac
connection-user=${ENV:DB_ACTINIO_USER}
connection-password=${ENV:DB_ACTINIO_PASSWORD}
						</code></pre>
						<span style="font-size: 0.325em;">fichero <i>blackhole.properties</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
connector.name=blackhole
						</code></pre>
					</section>
					<section>
						<h4>Configuración Trino</h4>
						<span style="font-size: 0.325em;">fichero <i>fermio.properties</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
connector.name=postgresql
### Conexión al FERMIO
connection-url=jdbc:postgresql://xxx.xxx.xxx.xxx:xxxx/pistac
connection-user=${ENV:DB_FERMIO_USER}
connection-password=${ENV:DB_FERMIO_PASSWORD}
#fermio.security=FILE
#fermio.config-file=/etc/trino/catalog/fermio-auth-rules.json
						</code></pre>
						<span style="font-size: 0.325em;">fichero <i>fermio-auth-rules.json</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
{
    "schemas": [{
            "user": "admin",
            "schema": ".*",
            "owner": true
        }, {
            "group": "finance|human_resources",
            "schema": "employees",
            "owner": true
        }, {
            "user": "guest",
            "owner": false
        }, {
            "schema": "default",
            "owner": true
        }
    ],
    "tables": [{
            "user": "admin",
            "privileges": ["SELECT", "INSERT", "DELETE", "OWNERSHIP"]
        }, {
            "user": "banned_user",
            "privileges": []
        }, {
            "schema": "hr",
            "table": "employee",
            "privileges": ["SELECT"],
            "filter": "user = current_user"
        }{
            "schema": "default",
            "table": ".*",
            "privileges": ["SELECT"],
            "columns": [{
                    "name": "address",
                    "allow": false
                }, {
                    "name": "ssn",
                    "mask": "'XXX-XX-' + substring(credit_card, -4)",
                    "mask_environment": {
                        "user": "admin"
                    }
                }
            ]
        }
    ],
    "session_properties": [{
            "property": "force_local_scheduling",
            "allow": true
        }, {
            "user": "admin",
            "property": "max_split_size",
            "allow": true
        }
    ]
}
						</code></pre>
					</section>
					<section>
						<h4>Configuración Trino</h4>
						<span style="font-size: 0.325em;">fichero <i>jmx.properties</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
connector.name=jmx
						</code></pre>
						<span style="font-size: 0.325em;">fichero <i>memory.properties</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
connector.name=memory
						</code></pre>
						<span style="font-size: 0.325em;">fichero <i>oistac.properties</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
connector.name=oracle
### Conexión al OISTAC
connection-url=jdbc:oracle:thin:@//xxx.xxx.xxx.xxx:xxxx/OISTAC
connection-user=${ENV:DB_OISTAC_USER}
connection-password=${ENV:DB_OISTAC_PASSWORD}
						</code></pre>
						<span style="font-size: 0.325em;">fichero <i>tpcds.properties</i></span>
						<pre style="font-size: 0.39em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
connector.name=tpcds
tpcds.splits-per-node=4
						</code></pre>
					</section>
				</section>

				<section>
					<h4>Configuración Trino</h4>
					<ol start="4" style="font-size: 0.65em;">
						<li>Configuración nodo worker</li>
						<span style="font-size: 0.5em;">fichero <i>config.properties</i></span>
						<pre style="font-size: 0.6em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">							
coordinator=false
http-server.http.port=8080
query.max-memory=50GB
query.max-memory-per-node=0.3GB
discovery.uri=http://mi-trino-coordinator:8080

internal-communication.shared-secret=KCZZItOB+oAMHi5jH59pt4pBE0l4zQc
						</code></pre>
					</ol>
				</section>

				<section>
					<h4>Configuración Trino</h4>
					<ol start="5" style="font-size: 0.5em;">
						<li>Configuración del cliente Trino-CLI</li>
						<ul>
							<li class="fragment current-visible"><b>Prerrequisito</b>: Instalar el certificado del servidor en el truststore de Java. (Windows)
								<ol>
									<li><span  style="font-size: 0.8em;">Descargar el certificado desde el servidor.</span><br/><pre style="font-size: 0.6em; width: 100%"><code data-trim data-noescape>keytool -printcert -rfc -sslserver cinco-ap01p.gobiernodecanarias.net:443 > cinco-ap01p.gobiernodecanarias.net.pem</code></pre></li>
									<li><span  style="font-size: 0.8em;">Localizar la ruta completa al truststore usado por Java.</span><br/><pre style="font-size: 0.6em; width: 100%"><code data-trim data-noescape>dir /s "C:\Program Files\Java\cacerts"</code></pre></li>
									<li><span  style="font-size: 0.8em;">Instalar el certificado en el truststore.</span><br/><pre style="font-size: 0.6em; width: 100%"><code data-trim data-noescape>keytool -import -trustcacerts -keystore cacerts -storepass changeit -alias cinco-ap01p -file cinco-ap01p.gobiernodecanarias.net.pem</code></pre></li>
								</ol>
							</li>
						</ul>
						<ol>
							<li class="fragment">Descargar desde <a href="https://docs.starburst.io/data-consumer/clients/cli.html">https://docs.starburst.io/data-consumer/clients/cli.html</a> el cliente Trino CLI y el cliente Trino JDBC.</li>
							<li class="fragment">Lanzar con el comando
							<pre style="font-size: 0.6em; width: 100%"><code data-trim data-noescape>java -jar trino-cli-373-executable.jar --server https://cinco-ap01p.gobiernodecanarias.net --user &lt;USUARIO&gt; --password</code></pre>
							</li>
							<li class="fragment">Para instalar en el Apache Hop, copiar el fichero trino-jdbc-373.jar descargado a subdirectorio plugins\databases\generic\lib.</li>
							<li class="fragment">Para instalar en el Pentaho Kettle, copiar el fichero trino-jdbc-373.jar descargado a subdirectorio lib.</li>
						</ol>
					</ol>
				</section>

<!-- PRUEBAS REALIZADAS -->
				<section>
				  <h3>Índice</h3>
				  <ol>
					<li>Introducción y conceptos básicos</li>
					<li>Funcionalidades</li>
					<li>Instalación y configuración</li>
					<li class="fragment highlight-red">Pruebas realizadas</li>
					<li>Conclusiones</li>
				  </ol>
				</section>

				<section>
					<h4>Pruebas</h4>
					<ol start="1" style="font-size: 0.65em;">
						<li>Mapeado de usuarios</li>
						<!--<p>Bloquear el acceso al cluster del usuario ext-fake y se permite al resto, además se mapean los usuarios ext-*@canarias y *@gobiernodecanarias.org a los usuarios sin dominio.</p>-->
						<span style="font-size: 0.5em;">fichero <i>config.properties</i></span>
						<pre style="font-size: 0.6em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
http-server.authentication.type=PASSWORD
http-server.authentication.password.user-mapping.file=etc/user-mapping.json
						</code></pre>
						
						<span style="font-size: 0.5em;">fichero <i>user-mapping.json</i></span>
						<pre style="font-size: 0.6em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;" data-line-numbers="3-6|7-12|13-16">
{
    "rules": [
        {
            "pattern": "etormed",
            "allow": false
        },
        {
            "pattern": "(ext-.+)",
            "case": "lower",
            "user": "$1@canarias.es",
            "allow": true
        },
        {
            "pattern": "(.+)",
            "allow": true
        }
    ]
}
						</code></pre>
					</ol>
				</section>

				<section>
					<h4>Pruebas</h4>
					<ol start="2" style="font-size: 0.65em;">
						<li>Control de acceso a catálogos y queries</li>
						<!--<p>Bloquear el acceso al cluster del usuario ext-fake y se permite al resto, además se mapean los usuarios ext-*@canarias y *@gobiernodecanarias.org a los usuarios sin dominio.</p>-->
						<span style="font-size: 0.5em;">fichero <i>access-control.properties</i></span>
						<pre style="font-size: 0.6em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;" data-line-numbers="2-2">
security.config-file=/etc/trino/cluster-auth-rules.test1.json
security.refresh-period=1s
						</code></pre>
						
						<span style="font-size: 0.5em;">fichero <i>cluster-auth-rules.test1.json</i></span>
						<pre style="font-size: 0.6em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;" data-line-numbers="3-7|8-11|12-14|17-20|21-24|25-27">
{
  "catalogs": [
    {
      "user": "(ext-jnunper@canarias.es|etormed)",
      "catalog": "actinio",
      "allow": "read-only"
    },
    {
      "catalog": "actinio",
      "allow": "none"
    },
    {
      "allow": "all"
    }
  ],
  "queries": [
    {
      "user": "ext-jnunper@canarias.es",
      "allow": ["execute", "kill", "view"]
    },
    {
      "user": "etormed",
      "allow": ["execute", "kill"]
    },
    {
      "allow": ["execute"]
    }
  ]
}
						</code></pre>
					</ol>
				</section>

				<section>
					<h4>Pruebas</h4>
					<ol start="3" style="font-size: 0.65em;">
						<li>Bloqueo de la interfaz web</li>
						<!--<p>Bloquear el acceso al cluster del usuario ext-fake y se permite al resto, además se mapean los usuarios ext-*@canarias y *@gobiernodecanarias.org a los usuarios sin dominio.</p>-->
						<span style="font-size: 0.5em;">fichero <i>config.properties</i></span>
						<pre style="font-size: 0.6em; width: 100%"><code data-trim data-noescape style="font-size: 0.6em;">
web-ui.enabled=false
						</code></pre>
					</ol>
				</section>

				<section>
					<h4>Pruebas</h4>
					<ol start="4" style="font-size: 0.65em;">
						<li>Control de acceso a catálogos y filtrado de datos</li>
						<span style="font-size: 0.35em;">fichero <i>config.properties</i></span>
						<pre style="font-size: 0.6em; width: 100%; margin-top: 4px; margin-bottom: 4px"><code data-trim data-noescape style="font-size: 0.6em;">
hide-inaccessible-columns=false
						</code></pre>
						<span style="font-size: 0.35em;">fichero <i>access-control.properties</i></span>
						<pre style="font-size: 0.6em; width: 100%; margin-top: 4px; margin-bottom: 4px"><code data-trim data-noescape style="font-size: 0.6em;">
security.config-file=/etc/trino/cluster-auth-rules.test1.json
						</code></pre>
						
						<span style="font-size: 0.35em;">fichero <i>cluster-auth-rules.test1.json</i></span>
						<pre style="font-size: 0.6em; width: 100%; margin-top: 4px"><code data-trim data-noescape style="font-size: 0.6em;" data-line-numbers="3-20|8-8|11-14|15-18|21-23">
{
  "tables": [
    {
      "user": "ext-jnunper@canarias.es",
      "catalog": "fermio",
      "schema": "e59021a_rd",
      "table": "dat_colcan20100131_v01",
      "privileges": ["SELECT"],
      "filter": "luid=501 or luid=502 or luid=503",
      "columns": [
        {
          "name": "stid",
          "allow": false
        },
        {
          "name": "uuid",
          "mask": "cast(concat(substring(uuid, 1, 23), '-*') as varchar(36))"
        }
      ]
    },
    {
      "privileges": ["SELECT", "INSERT", "DELETE", "UPDATE", "OWNERSHIP", "GRANT_SELECT"]
    }
  ]
}
						</code></pre>
					</ol>
				</section>

				<section>
					<section>
						<h4>Pruebas</h4>
						<p style="font-size: 0.5em;">Acceso desde Apache Hop a Trino</p>
						<img class="top framed" src="img/pantallazos/p012.png" style="width: 80%" />
					</section>
					<section>
						<img class="top framed" src="img/pantallazos/p014.png" />
					</section>
					<section>
						<img class="top framed" src="img/pantallazos/p013.png" />
					</section>
				</section>

				<section>
					<section>
						<h4>Pruebas</h4>
						<p style="font-size: 0.5em;">Acceso desde Kettle 8.3 a Trino</p>
						<img class="top framed" src="img/pantallazos/p015.png" style="width: 80%" />
					</section>
					<section>
						<img class="top framed" src="img/pantallazos/p016.png" />
					</section>
					<section>
						<img class="top framed" src="img/pantallazos/p017.png" />
					</section>
				</section>

				<section>
					<h4>Pruebas</h4>
					<p style="font-size: 0.5em;">Trino-CLI</p>
					<img class="top framed" src="img/pantallazos/p018.png" style="width: 80%" />
				</section>

				<section>
					<h4>Pruebas</h4>
					<p style="font-size: 0.5em;">Sencillo formulario web para realizar consultas contra Trino</p>
					<img class="top framed" src="img/pantallazos/p008.png" style="width: 80%" />
				</section>

<!-- CONCLUSIONES -->
				<section>
				  <h3>Índice</h3>
				  <ol>
					<li>Introducción y conceptos básicos</li>
					<li>Funcionalidades</li>
					<li>Instalación y configuración</li>
					<li>Pruebas realizadas</li>
					<li class="fragment highlight-red">Conclusiones</li>
				  </ol>
				</section>

				<section>
					<h4>Ventajas</h4> <img class="carita-r2-c1" /><br/>
					<ul style="font-size: 0.75em;">
						<li>Es gratis</li>
						<img class="fragment fade-in-then-out current-visible top framed" src="img/memes/no-2.gif" />
						<li class="fragment">Gestión uniforme de todas las fuentes de datos</li>
						<li class="fragment">Un control fino de los accesos</li>
						<li class="fragment">Categorizar las queries en diferentes prioridades</li>
						<li class="fragment">Facilita el análisis de datos (calidad y rendimiento)</li>
						<li class="fragment">Fácil de automatizar (REST API)</li>
						<li class="fragment">Queries optimizadas</li>
						<li class="fragment">...y muchas promesas!!</li>
					</ul>
				</section>
				
				<section>
					<h4>Desventajas - I</h4> <img class="carita-r1-c2" /><br/>
					<ol start=1">
						<li _class="fragment">Carencias:
							<ul>
								<li class="fragment" style="font-size: 0.65em;">No permite reutilizar queries</li>
								<li class="fragment" style="font-size: 0.65em;">No incluye una herramienta para la gestión de usuarios</li>
								<li class="fragment" style="font-size: 0.65em;">No hay herramienta para gestionar la configuración</li>
								<li class="fragment" style="font-size: 0.65em;">No soporta comentarios en los ficheros JSON</li>
								<li class="fragment" style="font-size: 0.65em;">No hay imagen docker oficial específica para coordinador y workers</li>
							</ul>
						</li>
					</ol>
				</section>
				
				<section>
					<h4>Desventajas - II</h4> <img class="carita-r3-c2" /><br/>
					<ol start=2">
						<li _class="fragment">No es idóneo para:
							<ul>
								<li class="fragment" style="font-size: 0.65em;">Queries fijas: No usa cachés</li>
								<li class="fragment" style="font-size: 0.65em;">Instalaciones en un único servidor</li>
								<li class="fragment" style="font-size: 0.65em;">Se pierde la posibilidad de auditar accesos a las BDD</li>
								<li class="fragment" style="font-size: 0.65em;">No aconsejado para docker short-lived</li>
								<li class="fragment" style="font-size: 0.65em;">Configuración de la memoria complicada</li>
							</ul>
						</li>
					</ol>
				</section>
				
				<section>
					<h4>Desventajas - III</h4> <img class="top carita-r1-c3" /><br/>
					<ol start=3">
						<li _class="fragment">Limitaciones/Problemas:
							<ul>
								<li class="fragment" style="font-size: 0.65em;">No soporta Oracle versiones &lt;12</li>
								<li class="fragment" style="font-size: 0.65em;">No soporta algunas de las funcionalidades de las fuentes de datos</li>
								<li class="fragment" style="font-size: 0.65em;">No soporta CAS/SSO</li>
								<li class="fragment" style="font-size: 0.65em;">Algunos tipos de datos no se soportan o requieren de configuración adicional</li>
								<li class="fragment" style="font-size: 0.65em;">El histórico de queries es volátil</li>
								<li class="fragment" style="font-size: 0.65em;">El driver JDBC no funciona bien con el Apache Hop/Pentaho</li>
								<li class="fragment" style="font-size: 0.65em;">Se debe reiniciar el cluster para quitar/poner catálogos</li>
							</ul>
						</li>
					</ol>
				</section>
				
				<section>
					<h4>Conclusiones</h4>
					<ol>
						<li></li>
						<li></li>
						<li></li>
						<li></li>
						<li></li>
						<li></li>
					</ol>
				</section>
				
				<section>
					<h4>Referencias</h4>
					<ol>
						<li>https://en.wikipedia.org/wiki/Presto_(SQL_query_engine)</li>
						<li>https://blog.starburst.io/intro-to-trino-for-the-trinewbie</li>
						<li>https://docs.starburst.io/data-consumer/clients/odbc.html</li>
						<li>https://www.sas.com/content/dam/SAS/support/en/sas-global-forum-proceedings/2019/3358-2019.pdf</li>
						<li>https://www.matillion.com/resources/blog/the-types-of-databases-with-examples</li>
						<li>https://www.javatpoint.com/types-of-databases</li>
						<li>https://trino.io/docs/current/develop/client-protocol.html</li>
						<li></li>
						<li></li>
						<li></li>
						<li></li>
						<li></li>
						<li></li>
					</ol>
				</section>

<!-- FINAL -->
				<section>
					<section id="grand-finale">
						<img class="top framed" src="img/memes/fireworks-celebrate.gif" />
						<h2>Fin</h2>
						<a href="#/0" style="font-size: 0.5em;">Volver a empezar</a>
					</section>
					<section>
						<img class="top framed" src="img/memes/fireworks-dance.gif" />
					</section>
				</section>
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight ]
			});
		</script>

    <!-- Hack to add header/footer: https://stackoverflow.com/a/37518822 👇🏻 -->

    <!-- Create hidden header/footer <div> -->
    <div id="hidden" style="display: none">
      <div id="header">
        <div id="header-left"></div>
        <div id="header-right">
          <img class="logo" src="img/trino_logo.png" title="Commander Bun Bun" alt="Trino logo" />
        </div>
        <div id="footer-left">
          <img class="logo" src="img/istac-logo.svg" alt="ISTAC LOGO" />
          <div class="label" style="font-size: 0.5em;">
            <a href="http://www.gobiernodecanarias.org/istac/">ISTAC</a> | Miguel Núñez<a href="https://evm.net"> EVM</a> | 2022
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script type="text/javascript">
      // On Reveal.js ready event, copy header/footer <div> into each `.slide-background` <div>
      var header = $("#header").html();
      if (window.location.search.match(/print-pdf/gi)) {
        Reveal.addEventListener("ready", function (event) {
          $(".slide-background").append(header);
        });
      } else {
        $("div.reveal").append(header);
      }

      Reveal.configure({ pdfSeparateFragments: false });
    </script>

    <!-- Hack to add header/footer: https://stackoverflow.com/a/37518822 👆🏻 -->
	</body>
</html>
